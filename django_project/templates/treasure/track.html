{% extends 'treasure/base.html' %}

{% load static %}

{% block title %}
    Track
{% endblock %}

{% block body_block %}
<div style="height:480px; width:640px">
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDudWkR_tpJ06lIarBZm3qIngNAae1RXNw&scale=1&signed_in=true"></script>

        <div>
          <ul style="margin: 0;">
            Downloads
            <input style="margin-right: 5px;" id="DownloadsCheckbox" type="checkbox" onclick="toggleGroup('Downloaded')" {% ifequal timeline 'timeline'%}disabled="disabled"{% endifequal %} checked="checked" />Usage
            <input style="margin-right: 5px;"  id="UsageCheckbox" type="checkbox" onclick="toggleGroup('Used')" {% ifequal timeline 'timeline'%}disabled="disabled" checked="checked"{% endifequal %} />Feedback
            <input style="margin-right: 30px;" id="FeedbackCheckbox" type="checkbox" onclick="toggleGroup('Rated')" {% ifequal timeline 'timeline'%}disabled="disabled" checked="checked"{% endifequal %} />People happy to discuss it
            <input style="margin-right: 30px;" id="DiscussionCheckbox" type="checkbox" onclick="toggleGroup('Discuss')" {% ifequal timeline 'timeline'%}disabled="disabled"{% endifequal %} />
                {% ifequal timeline 'timeline' %}
            <div class='btn' onclick='window.location.assign("../")'>Timeline Animation <input type="checkbox" checked="checked"/></div>
            {% else %}
            <div class='btn' onclick='window.location.assign("./timeline/")'>Timeline Animation <input type="checkbox"/></div>
            {% endifequal%}

            <select id="mapCenter" class="span2" style="margin-top: 10px;">
                <option value="Scotland" >Scotland</option>
                <option value="User">MySchool</option>
                <option value="UK">UK</option>
                <option value="Bounds">Best View</option>
              </select>
          </ul>
        </div>
        <div id="map" style="height: 100%; min-height: 480px; width: 100%"><div style="text-align:center;">
			<span style="color:Gray;">Loading map...</span>
		</div>
  
  <div id="legend" style="z-index: 0; position: absolute; top: 0px; left: 100px;">
	  <b>Resources:</b> <img src="{% static 'images/dlicon.png' %}" alt="Downlaoded" /> Downloaded
	  <img src="{% static 'images/classicon.png' %}" alt="Used" /> Used
	</div>
    </div>
    </div>
    <script type="text/javascript">
  var boundZoom=0;
  var downloaded=[];
  var used=[];
  var rated=[];
  var discuss=[];
  var maxLat = -90;
  var minLat = 90;
  var maxLon = -180;
  var minLon = 180;
  {% for download in downloaded %}
  pushNcheck("Downloaded",{{download.latitude}},{{download.longitude}});
  {% endfor %}
  {% for usage in used %}
  pushNcheck("Used",{{usage.latitude}},{{usage.longitude}});
  {% endfor %}
  {% for rating in rated %}
  pushNcheck("Rated",{{rating.latitude}},{{rating.longitude}});
  {% endfor %}
  {% for person in discuss %}
  pushNcheck("Discuss",{{person.latitude}},{{person.longitude}});
  {% endfor %}

  var infoWindow = new google.maps.InfoWindow();
  var UK = {lat: 54.53, lng: -4.17};
  var Scotland = {lat: 57.63, lng: -4.25};
  var User = {lat: {{lat}}, lng: {{lng}}};
  var dlicon="{% static 'images/dlicon.png' %}";
  var classicon="{% static 'images/classicon.png' %}";
  var fbicon="{% static 'images/feedback.png' %}";


  var markers={
    "Downloaded": [],
    "Used": [],
    "Rated": [],
    "Discuss": []
  };

var map = new google.maps.Map(document.getElementById('map'), {
  zoom: 4,
  center: Scotland,
  zIndex: 1,
});
var infoWindow = new google.maps.InfoWindow();

var loadingTime=14000;
var delay= {{animationTimeout}};

for (i = 0; i < downloaded.length; i++) {
  {% ifequal timeline 'timeline' %}addMarkerWithTimeout(downloaded, i, (loadingTime+i*delay), dlicon, "Downloaded");{% else %}addMarker(downloaded, i, dlicon, "Downloaded");{% endifequal %}
}

for (i = 0; i < used.length; i++) {
  {% ifequal timeline 'timeline' %}addMarkerWithTimeout(used, i, (loadingTime+i*delay), classicon, "Used");{% else %}addMarker(used, i, classicon, "Used");{% endifequal %}
}

for (i = 0; i < rated.length; i++) {
  {% ifequal timeline 'timeline' %}addMarkerWithTimeout(rated, i, (loadingTime+i*delay), fbicon, "Rated");{% else %}addMarker(rated, i, fbicon, "Rated");{% endifequal %}
}

for (i = 0; i < discuss.length; i++) {
  {% ifequal timeline 'timeline' %}addMarkerWithTimeout(discuss, i, (loadingTime+i*delay), fbicon, "Happy to talk about it!");{% else %}addMarker(rated, i, fbicon, "Discuss");{% endifequal %}
}

{% ifequal timeline 'timeline' %}toggleGroup("Discuss");{% endifequal %}
var tmpLat=((maxLat + minLat)/2.0);
var tmpLon=((maxLon + minLon)/2.0);
var boundCenter= {lat: tmpLat, lng:tmpLon};
var zoom1=0, zoom2=0;

//Determine the best zoom level based on the map scale and bounding coordinate information

{
    //best zoom level based on map width
    zoom1 = Math.log(360.0 / 256.0 * (640-20) / (maxLon - minLon)) / Math.log(2);
    //best zoom level based on map height
    zoom2 = Math.log(180.0 / 256.0 * (480-20) / (maxLat - minLat)) / Math.log(2);

    //use the most zoomed out of the two zoom levels
    boundZoom = Math.ceil((zoom1 < zoom2) ? zoom1 : zoom2);
}

function pushNcheck(markerType, pushLat,pushLon){
    if (markerType=="Downloaded"){
      downloaded.push({lat:pushLat, lng: pushLon });
    }else if (markerType=="Used"){
      used.push({lat:pushLat, lng: pushLon });
    }else if (markerType=="Rated"){
      rated.push({lat:pushLat, lng: pushLon });
    }else if (markerType=="Discuss"){
      discuss.push({lat:pushLat, lng: pushLon });
    }
    if (pushLat>maxLat) maxLat=pushLat;
    if (pushLat<minLat) minLat=pushLat;
    if (pushLon>maxLon) maxLon=pushLon;
    if (pushLon<minLon) minLon=pushLon;

}

function instantBounds(){
    var bounds = new google.maps.LatLngBounds();
    var types= ["Downloaded", "Used", "Rated", "Discuss"];
    var type='';
    for (var j=0; j<4; j++) {
        type=types[j];
        for (var i = 0; i < markers[type].length; i++) {
          var markerPosition =  markers[type][i].getPosition();
          if (markers[type][i].getVisible()) {
            bounds.extend(markerPosition);
          }
        }
    }
    return bounds
}

function addMarkerWithTimeout(array, index, timeout, icon, title) {
  window.setTimeout(function(){addMarker(array, index,icon, title);}, timeout);
}

function addMarker(array, index, icon, title) {
    var marker= new google.maps.Marker({
      position: array[index],
      map: map,
      icon: icon,
      animation: google.maps.Animation.DROP,
      title: title,
      zIndex: index+2
    })
    if (!markers[title]) markers[title] = [];
    markers[title].push(marker);
    var html = "<b>" + title + "</b> <br/>";
    bindInfoWindow(marker, map, infoWindow, html);
  }

function toggleGroup(type) {
  for (var i = 0; i < markers[type].length; i++) {
    var marker = markers[type][i];
    if (!marker.getVisible()) {
      marker.setVisible(true);
    } else {
      marker.setVisible(false);
    }
  }
}

function center(spot) {
  var location;
  var zoom;
  if (spot=='Scotland'){
    location= Scotland;
    zoom=6;
  }else if (spot=='UK'){
    location= UK;
    zoom=5;
  }else if (spot=='User'){
    location= User;
    zoom=6;
  }else if (spot=='Bounds'){
    location= boundCenter;
    zoom=boundZoom-1;
  }
  map.setCenter(location);
  map.setZoom(zoom);
  if (spot=="Bounds"){
    var ccenter=map.getCenter();
    var zzoom=map.getZoom();
    var stop=map.getZoom();
  }
}

function bindInfoWindow(marker, map, infoWindow, html) {
  google.maps.event.addListener(marker, 'click', function() {
    infoWindow.setContent(html);
    infoWindow.open(map, marker);

  });
}
</script>
<script>
  $('#mapCenter').change(function(){
    var location = $(this).find('option:selected').attr('value');
    center(location);
});
</script>
<script async defer type="text/javascript">
  {% ifequal timeline 0 %}
  toggleGroup('Rated');
  toggleGroup('Used');
  {% endifequal %}
  toggleGroup('Discuss');
</script>


{% endblock %}